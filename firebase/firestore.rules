rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isAuth() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    function isAdmin() {
      let path = /databases/$(database)/documents/userProfiles/$(request.auth.uid);
      return isAuth() && exists(path) && get(path).data.role == 'admin';
    }

    // Clients: all authenticated staff can read and write
    match /clients/{clientId} {
      allow read, write: if isAuth();
      match /diagnosisHistory/{entryId} {
        allow read, write: if isAuth();
      }
      match /notes/{noteId} {
        allow read, write: if isAuth();
      }
    }

    // Reports: all authenticated staff can read and write
    match /reports/{reportId} {
      allow read, write: if isAuth();
    }

    // User profiles: all authenticated staff can read (for assignee/doctor dropdowns); own write or admin
    match /userProfiles/{uid} {
      allow read: if isAuth();
      allow write: if isAuth() && request.auth.uid == uid;
      allow write: if isAdmin();

      // Per-user config (legacy); only the owner
      match /config/{docId} {
        allow read, write: if isOwner(uid);
      }
    }

    // Org-wide config (diagnosis, wards, rooms, parameter lists): read all auth, write admin only
    match /config/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Tasks (MVP-2): any authenticated user can read and write
    match /tasks/{taskId} {
      allow read, write: if isAuth();
    }

    // Audit log: any auth can create; only admin can read
    match /auditLog/{docId} {
      allow create: if isAuth();
      allow read: if isAdmin();
    }
  }
}

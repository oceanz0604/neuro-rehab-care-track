<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <script>
    (function(){ try { var t = localStorage.getItem('caretrack-theme'); if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark'); } catch(e) {} })();
  </script>
  <title>Maitra Wellness</title>
  <meta name="theme-color" content="#0d9488">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Maitra Wellness">
  <meta name="description" content="Maitra Wellness — Clinical Rehabilitation Reporting">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/jpeg" href="static/icons/logo.jpg">
  <link rel="apple-touch-icon" href="static/icons/logo.jpg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="static/css/main.css">
</head>
<body>

<!-- ═══════ LOADING (shown until auth resolved) ═══════ -->
<div id="loading-screen" class="loading-screen">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>

<!-- ═══════ LOGIN ═══════ -->
<div id="login-screen" class="login-screen" style="display:none">
  <div class="login-card">
    <div class="login-header">
      <div class="login-icon"><img src="static/icons/logo.jpg" alt="Maitra Wellness"></div>
      <h1>Maitra Wellness</h1>
      <p>Psychiatric Rehabilitation Center</p>
    </div>
    <form id="login-form" autocomplete="on">
      <div class="fg">
        <label for="l-email">Email</label>
        <input id="l-email" type="email" class="fi" placeholder="you@centre.org" required autocomplete="email">
      </div>
      <div class="fg">
        <label for="l-password">Password</label>
        <input id="l-password" type="password" class="fi" placeholder="Min. 6 characters" required autocomplete="current-password" minlength="6">
      </div>
      <p id="login-error" class="error-msg" style="display:none"></p>
      <button type="submit" id="login-btn" class="btn btn-block">Sign in</button>
      <p class="login-hint">No account? Contact your administrator.</p>
    </form>
  </div>
</div>

<!-- ═══════ APP SHELL ═══════ -->
<div id="app-shell" class="app" hidden>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-brand">
      <img id="sb-brand-logo" src="static/icons/logo.jpg" alt="" class="sb-brand-logo">
      <div class="sb-brand-inner">
        <span class="sb-brand-text" id="sb-brand-text">Maitra Wellness</span>
        <span class="sb-name" id="sb-name">Staff</span>
      </div>
    </div>
    <nav class="sb-nav">
      <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
      <a href="#" class="nav-link" data-page="tasks"><i class="fas fa-list-check"></i><span>Tasks</span></a>
      <a href="#" class="nav-link" data-page="patients"><i class="fas fa-hospital-user"></i><span>Patients</span></a>
      <a href="#" class="nav-link" data-page="reports"><i class="fas fa-file-lines"></i><span>Reports - BETA</span></a>
      <a href="#" class="nav-link nav-link-chat" data-page="comms"><i class="fas fa-comments"></i><span>Team Chat - BETA</span><span id="chat-unread-badge" class="nav-badge"></span></a>
      <a href="#" class="nav-link" data-page="freport"><i class="fas fa-file-medical"></i><span>Progress Report - BETA</span></a>
    </nav>
    <div class="sb-foot">
      <a href="#" class="nav-link" data-page="admin" id="nav-admin" style="display:none"><i class="fas fa-shield-halved"></i><span>Admin - BETA</span></a>
      <button type="button" id="logout-btn" class="nav-link logout-btn"><i class="fas fa-right-from-bracket"></i><span>Sign out</span></button>
    </div>
  </aside>
  <div class="sb-overlay" id="sb-overlay"></div>

  <!-- Main -->
  <div class="main-wrap">
    <header class="topbar">
      <button type="button" id="menu-btn" class="menu-btn"><i class="fas fa-bars"></i></button>
      <h2 class="tb-title" id="tb-title">Dashboard</h2>
      <div class="tb-right">
        <button type="button" class="notif-btn" id="tb-dashboard-btn" title="Dashboard" aria-label="Dashboard"><i class="fas fa-house"></i></button>
        <button type="button" class="notif-btn" id="global-refresh-btn" title="Refresh data" aria-label="Refresh"><i class="fas fa-arrows-rotate"></i></button>
        <button type="button" class="theme-toggle-btn notif-btn" id="theme-toggle" title="Toggle dark/light theme" aria-label="Theme">
          <i class="fas fa-moon" id="theme-icon"></i>
        </button>
      </div>
    </header>

    <main class="main-content">

      <!-- ── Dashboard ── -->
      <section class="page active" id="page-dashboard">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px">
          <h1 class="pg-title" id="d-greet" style="margin-bottom:0">Dashboard</h1>
        </div>
        <p class="pg-sub" id="d-date"></p>
        <div class="stats-row" id="dash-stats"></div>
        <div id="dash-my-patients"></div>
        <div class="two-col">
          <div class="card card-accent-danger"><div class="card-hd card-hd-accent"><i class="fas fa-triangle-exclamation"></i> Risk Alerts</div><div id="risk-alerts"></div></div>
          <div class="card card-accent"><div class="card-hd card-hd-primary"><i class="fas fa-clock-rotate-left"></i> Recent Reports</div><div id="recent-rpts"></div></div>
        </div>
      </section>

      <!-- ── Patients ── -->
      <section class="page" id="page-patients">
        <div class="patients-toolbar">
          <div class="search-box"><i class="fas fa-magnifying-glass"></i><input type="text" id="pt-search" placeholder="Search by name..."></div>
          <button type="button" class="btn btn-sm" id="add-patient-btn"><i class="fas fa-plus"></i> Add Patient</button>
        </div>
        <div id="patients-table" class="patients-card-grid"></div>
      </section>

      <!-- ── Reports ── -->
      <section class="page" id="page-reports">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px">
          <h1 class="pg-title" style="margin-bottom:0">Reports</h1>
          <span id="reports-total" class="hist-total"></span>
        </div>
        <div class="reports-patient-cards-wrap" style="margin-bottom:20px">
          <div class="search-box" style="max-width:280px;margin-bottom:10px"><i class="fas fa-magnifying-glass"></i><input type="text" id="reports-patient-search" placeholder="Search patients..."></div>
          <div class="reports-patient-cards" id="reports-patient-cards"></div>
        </div>
        <div class="list-toolbar">
          <select class="filter-select" id="reports-date-range">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">Last 7 days</option>
            <option value="4weeks">Last 4 weeks</option>
            <option value="custom">Custom date</option>
          </select>
          <span id="reports-custom-dates" style="display:none;align-items:center;gap:6px">
            <input type="date" id="reports-date-from" class="fi" style="width:auto;padding:6px 8px">
            <span>to</span>
            <input type="date" id="reports-date-to" class="fi" style="width:auto;padding:6px 8px">
          </span>
          <select class="filter-select" id="reports-filter-section">
            <option value="">All sections</option>
            <option value="psychiatric">Psychiatric</option>
            <option value="behavioral">Behavioral</option>
            <option value="medication">Medication</option>
            <option value="adl">ADL</option>
            <option value="therapeutic">Therapeutic</option>
            <option value="risk">Risk</option>
          </select>
          <div class="search-box"><i class="fas fa-magnifying-glass"></i><input type="text" id="reports-search" placeholder="Search by patient..."></div>
        </div>
        <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="reports-table"></div></div>
      </section>

      <!-- ── Team Chat (WhatsApp-style: channels pinned top, input fixed bottom) ── -->
      <section class="page" id="page-comms">
        <h1 class="pg-title">Team Chat</h1>
        <div class="chat-layout chat-layout-wa">
          <div class="chat-main">
            <div class="channel-list channel-list-pinned" id="channel-list"></div>
            <div class="chat-header" id="chat-header">General Ward</div>
            <div class="msg-list" id="msg-list"></div>
            <div class="chat-compose chat-compose-fixed">
              <input type="text" id="msg-in" placeholder="Type a message..." autocomplete="off">
              <button type="button" class="urgent-toggle" id="urgent-toggle" title="Mark as urgent"><i class="fas fa-exclamation-triangle"></i></button>
              <button type="button" class="btn btn-sm" id="send-msg"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- ── Progress Report (family-facing) ── -->
      <section class="page" id="page-freport">
        <h1 class="pg-title" id="fr-title">Progress Report</h1>
        <p class="pg-sub" id="fr-sub">Date range &mdash; supportive language only</p>
        <div class="fr-controls">
          <div class="fg" style="min-width:180px"><label id="fr-lbl-c">Client</label><select class="fi" id="fr-cl"><option value="">— Choose client —</option></select></div>
          <div class="fg" style="min-width:140px"><label id="fr-lbl-from">From date</label><input type="date" class="fi" id="fr-date-from"></div>
          <div class="fg" style="min-width:140px"><label id="fr-lbl-to">To date</label><input type="date" class="fi" id="fr-date-to"></div>
          <div class="fg"><label id="fr-lbl-l">Language</label><div style="display:flex;gap:6px"><button type="button" class="lbtn active" data-lang="en">English</button><button type="button" class="lbtn" data-lang="mr">मराठी</button></div></div>
        </div>
        <p id="fr-noc" class="empty-state"><i class="fas fa-file-medical"></i>Select a client to preview.</p>
        <div id="fr-prev" class="fr-preview" hidden></div>
      </section>

      <!-- ── Tasks (JIRA-style: Board + List) ── -->
      <section class="page" id="page-tasks">
        <div class="tasks-toolbar">
          <div class="tasks-toolbar-left">
            <h1 class="pg-title" style="margin:0">Tasks</h1>
            <div class="tasks-view-toggle" role="tablist">
              <button type="button" class="btn btn-sm tasks-view-btn active" data-view="board" aria-selected="true"><i class="fas fa-columns"></i> Board</button>
              <button type="button" class="btn btn-sm btn-outline tasks-view-btn" data-view="list" aria-selected="false"><i class="fas fa-list"></i> List</button>
            </div>
          </div>
          <button type="button" class="btn btn-sm" id="tasks-add-btn"><i class="fas fa-plus"></i> Create</button>
        </div>
        <div class="list-toolbar" style="margin-bottom:12px">
          <select class="filter-select" id="tasks-filter-status">
            <option value="">All statuses</option>
            <option value="todo">To Do</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
          </select>
          <select class="filter-select" id="tasks-filter-client"><option value="">All patients</option></select>
          <select class="filter-select" id="tasks-filter-assignee"><option value="">All assignees</option></select>
        </div>
        <div id="tasks-board-wrap" class="tasks-board-wrap">
          <div class="task-board" id="task-board">
            <div class="task-board-column" data-status="todo">
              <div class="task-board-col-hd"><span class="task-board-col-title"><span class="task-board-col-dot dot-todo"></span> To Do</span><span class="task-board-col-count" id="task-count-todo">0</span></div>
              <div class="task-board-cards" id="task-col-todo"></div>
            </div>
            <div class="task-board-column" data-status="in_progress">
              <div class="task-board-col-hd"><span class="task-board-col-title"><span class="task-board-col-dot dot-in_progress"></span> In Progress</span><span class="task-board-col-count" id="task-count-in_progress">0</span></div>
              <div class="task-board-cards" id="task-col-in_progress"></div>
            </div>
            <div class="task-board-column" data-status="done">
              <div class="task-board-col-hd"><span class="task-board-col-title"><span class="task-board-col-dot dot-done"></span> Done</span><span class="task-board-col-count" id="task-count-done">0</span></div>
              <div class="task-board-cards" id="task-col-done"></div>
            </div>
          </div>
        </div>
        <div id="tasks-list-wrap" class="tasks-list-wrap" style="display:none">
          <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="tasks-list"></div></div>
        </div>
      </section>

      <!-- ── Admin (Staff | Report Parameters | Ward & Beds | Diagnosis Options | Audit Logs) ── -->
      <section class="page" id="page-admin">
        <div class="admin-tabs" style="display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px;flex-wrap:wrap">
          <button type="button" class="btn btn-sm admin-tab active" data-admin-tab="staff"><i class="fas fa-users"></i> Staff</button>
          <button type="button" class="btn btn-sm btn-outline admin-tab" data-admin-tab="report-params"><i class="fas fa-list-check"></i> Report Parameters</button>
          <button type="button" class="btn btn-sm btn-outline admin-tab" data-admin-tab="ward-beds"><i class="fas fa-bed"></i> Ward &amp; Beds</button>
          <button type="button" class="btn btn-sm btn-outline admin-tab" data-admin-tab="diagnosis"><i class="fas fa-stethoscope"></i> Diagnosis Options</button>
          <button type="button" class="btn btn-sm btn-outline admin-tab" data-admin-tab="audit"><i class="fas fa-clipboard-list"></i> Audit Logs</button>
        </div>
        <div id="admin-staff-wrap">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
            <h2 class="pg-title" style="margin:0;font-size:1.1rem">Staff Management</h2>
            <button type="button" class="btn btn-sm" id="add-staff-btn"><i class="fas fa-user-plus"></i> Add Staff</button>
          </div>
          <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="staff-table"></div></div>
        </div>
        <div id="admin-report-params-wrap" style="display:none">
          <h2 class="pg-title" style="margin:0 0 8px 0;font-size:1.1rem">Report Parameters</h2>
          <p class="pg-sub" style="margin-bottom:16px">Edit each section and click Save. Changes are not auto-saved.</p>
          <div id="report-params-content"></div>
        </div>
        <div id="admin-ward-beds-wrap" style="display:none">
          <h2 class="pg-title" style="margin:0 0 8px 0;font-size:1.1rem">Ward &amp; Beds</h2>
          <p class="pg-sub" style="margin-bottom:16px">Ward names and room/bed numbers. Edit and click Save per section.</p>
          <div id="ward-beds-content"></div>
        </div>
        <div id="admin-diagnosis-wrap" style="display:none">
          <h2 class="pg-title" style="margin:0 0 8px 0;font-size:1.1rem">Diagnosis Options</h2>
          <p class="pg-sub" style="margin-bottom:16px">ICD-11 diagnosis list used across the app. Edit and click Save.</p>
          <div id="diagnosis-options-content"></div>
        </div>
        <div id="admin-audit-wrap" style="display:none">
          <h2 class="pg-title" style="margin:0 0 8px 0;font-size:1.1rem">Audit Logs</h2>
          <p class="pg-sub" style="margin-bottom:16px">Recent actions: report saves, client add/update/discharge.</p>
          <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="audit-table"></div></div>
          <button type="button" class="btn btn-outline btn-sm" id="audit-load-more" style="margin-top:8px;display:none">Load more</button>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Modal overlay: direct child of body so it is never clipped or hidden by #app-shell -->
<div class="modal-overlay" id="modal-overlay" aria-hidden="true"><div id="modal-container"></div></div>

<!-- Toast -->
<div id="toast" data-show="false"></div>

<!-- PWA Install banner -->
<div id="pwa-install-banner" class="pwa-install-banner" hidden>
  <div class="pwa-install-inner">
    <div class="pwa-install-icon"><i class="fas fa-brain"></i></div>
    <div class="pwa-install-text">
      <strong>Install CareTrack</strong>
      <span>Add to home screen for quick access</span>
    </div>
    <div class="pwa-install-actions">
      <button type="button" class="btn btn-ghost btn-sm" id="pwa-install-dismiss">Not now</button>
      <button type="button" class="btn btn-sm" id="pwa-install-btn"><i class="fas fa-download"></i> Install</button>
    </div>
    <button type="button" class="pwa-install-close" id="pwa-install-close" aria-label="Close"><i class="fas fa-times"></i></button>
  </div>
</div>

<!-- Firebase SDKs (compat for no-bundler setup) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>

<!-- App scripts (order matters) -->
<script src="static/js/firebase-config.js"></script>
<script src="static/js/db.js"></script>
<script src="static/js/push-notifications.js"></script>
<script src="static/js/permissions.js"></script>
<script src="static/js/rtdb.js"></script>
<script src="static/js/components/modal.js"></script>
<script src="static/js/components/report-modal.js"></script>
<script src="static/js/pages/dashboard.js"></script>
<script src="static/js/pages/patients.js"></script>
<script src="static/js/pages/reports.js"></script>
<script src="static/js/pages/patient-detail.js"></script>
<script src="static/js/pages/team.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
<script src="static/js/pages/family-report.js"></script>
<script src="static/js/pages/tasks.js"></script>
<script src="static/js/pages/admin.js"></script>
<script src="static/js/pages/settings.js"></script>
<script src="static/js/app.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <script>
    (function(){ try { var t = localStorage.getItem('caretrack-theme'); if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark'); } catch(e) {} })();
  </script>
  <title>NeuroRehab CareTrack</title>
  <meta name="theme-color" content="#0d9488">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CareTrack">
  <meta name="description" content="Clinical Neuro-Psychiatric Rehabilitation Reporting System">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<!-- ═══════ LOGIN ═══════ -->
<div id="login-screen" class="login-screen">
  <div class="login-card">
    <div class="login-header">
      <div class="login-icon"><i class="fas fa-brain"></i></div>
      <h1>NeuroRehab CareTrack</h1>
      <p>Clinical Rehabilitation Reporting</p>
    </div>
    <form id="login-form" autocomplete="on">
      <div class="fg">
        <label for="l-email">Email</label>
        <input id="l-email" type="email" class="fi" placeholder="you@centre.org" required autocomplete="email">
      </div>
      <div class="fg">
        <label for="l-password">Password</label>
        <input id="l-password" type="password" class="fi" placeholder="Min. 6 characters" required autocomplete="current-password" minlength="6">
      </div>
      <p id="login-error" class="error-msg" style="display:none"></p>
      <button type="submit" id="login-btn" class="btn btn-block">Sign in</button>
      <p class="login-hint">No account? Contact your administrator.</p>
    </form>
  </div>
</div>

<!-- ═══════ APP SHELL ═══════ -->
<div id="app-shell" class="app" hidden>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-brand"><i class="fas fa-brain"></i><span>CareTrack</span></div>
    <div class="sb-user">
      <div class="sb-avatar" id="sb-avatar">S</div>
      <div><div class="sb-name" id="sb-name">Staff</div><div class="sb-role" id="sb-role">&mdash;</div></div>
    </div>
    <nav class="sb-nav">
      <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
      <a href="#" class="nav-link" data-page="patients"><i class="fas fa-hospital-user"></i><span>Patients</span></a>
      <a href="#" class="nav-link" data-page="comms"><i class="fas fa-comments"></i><span>Team Chat</span></a>
      <a href="#" class="nav-link" data-page="freport"><i class="fas fa-file-medical"></i><span>Family Reports</span></a>
      <a href="#" class="nav-link" data-page="admin" id="nav-admin" style="display:none"><i class="fas fa-shield-halved"></i><span>Admin</span></a>
    </nav>
    <div class="sb-foot"><button id="logout-btn" class="logout-btn"><i class="fas fa-right-from-bracket"></i><span>Sign out</span></button></div>
  </aside>
  <div class="sb-overlay" id="sb-overlay"></div>

  <!-- Main -->
  <div class="main-wrap">
    <header class="topbar">
      <button type="button" id="menu-btn" class="menu-btn"><i class="fas fa-bars"></i></button>
      <h2 class="tb-title" id="tb-title">Dashboard</h2>
      <div class="tb-right">
        <button type="button" class="theme-toggle-btn notif-btn" id="theme-toggle" title="Toggle dark/light theme" aria-label="Theme">
          <i class="fas fa-moon" id="theme-icon"></i>
        </button>
        <button type="button" class="notif-btn" id="notif-btn" title="Notifications">
          <i class="fas fa-bell"></i>
          <span id="notif-badge"></span>
        </button>
        <span class="shift-badge" id="shift-badge">Morning</span>
      </div>
      <div class="notif-panel" id="notif-panel"></div>
    </header>

    <main class="main-content">

      <!-- ── Dashboard ── -->
      <section class="page active" id="page-dashboard">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px">
          <h1 class="pg-title" id="d-greet" style="margin-bottom:0">Dashboard</h1>
          <button type="button" class="btn btn-outline btn-sm" id="dash-refresh"><i class="fas fa-arrows-rotate"></i> Refresh</button>
        </div>
        <p class="pg-sub" id="d-date"></p>
        <div class="stats-row" id="dash-stats"></div>
        <div class="two-col">
          <div class="card card-accent-danger"><div class="card-hd card-hd-accent"><i class="fas fa-triangle-exclamation"></i> Risk Alerts</div><div id="risk-alerts"></div></div>
          <div class="card card-accent"><div class="card-hd card-hd-primary"><i class="fas fa-clock-rotate-left"></i> Recent Reports</div><div id="recent-rpts"></div></div>
        </div>
      </section>

      <!-- ── Patients ── -->
      <section class="page" id="page-patients">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
          <h1 class="pg-title" style="margin-bottom:0">Patients</h1>
          <button type="button" class="btn btn-sm" id="add-patient-btn"><i class="fas fa-plus"></i> Add Patient</button>
        </div>
        <div class="list-toolbar">
          <div class="search-box"><i class="fas fa-magnifying-glass"></i><input type="text" id="pt-search" placeholder="Search by name..."></div>
          <select class="filter-select" id="pt-filter-status"><option value="">All Status</option><option value="active">Active</option><option value="discharged">Discharged</option></select>
          <select class="filter-select" id="pt-filter-risk"><option value="">All Risk</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option><option value="none">None</option></select>
        </div>
        <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="patients-table"></div></div>
      </section>

      <!-- ── Patient Detail ── -->
      <section class="page" id="page-patient-detail">
        <div id="pd-header"></div>
        <div class="tab-bar" id="pd-tabs"></div>
        <div id="pd-content"></div>
      </section>

      <!-- ── Team Chat ── -->
      <section class="page" id="page-comms">
        <h1 class="pg-title">Team Chat</h1>
        <div class="chat-layout">
          <div class="channel-list" id="channel-list"></div>
          <div class="chat-main">
            <div class="chat-header" id="chat-header">General Ward</div>
            <div class="msg-list" id="msg-list"></div>
            <div class="chat-compose">
              <input type="text" id="msg-in" placeholder="Type a message..." autocomplete="off">
              <button type="button" class="urgent-toggle" id="urgent-toggle" title="Mark as urgent"><i class="fas fa-exclamation-triangle"></i></button>
              <button type="button" class="btn btn-sm" id="send-msg"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- ── Family Reports ── -->
      <section class="page" id="page-freport">
        <h1 class="pg-title" id="fr-title">Family Progress Reports</h1>
        <p class="pg-sub" id="fr-sub">Monthly &mdash; supportive language only</p>
        <div class="fr-controls">
          <div class="fg" style="min-width:180px"><label id="fr-lbl-c">Client</label><select class="fi" id="fr-cl"><option value="">— Choose client —</option></select></div>
          <div class="fg" style="min-width:160px"><label id="fr-lbl-m">Report month</label><input type="month" class="fi" id="fr-mon"></div>
          <div class="fg"><label id="fr-lbl-l">Language</label><div style="display:flex;gap:6px"><button type="button" class="lbtn active" data-lang="en">English</button><button type="button" class="lbtn" data-lang="mr">मराठी</button></div></div>
        </div>
        <p id="fr-noc" class="empty-state"><i class="fas fa-file-medical"></i>Select a client to preview.</p>
        <div id="fr-prev" class="fr-preview" hidden></div>
      </section>

      <!-- ── Admin (Staff + Settings) ── -->
      <section class="page" id="page-admin">
        <div class="admin-tabs" style="display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px">
          <button type="button" class="btn btn-sm admin-tab active" data-admin-tab="staff"><i class="fas fa-users"></i> Staff</button>
          <button type="button" class="btn btn-sm btn-outline admin-tab" data-admin-tab="settings"><i class="fas fa-gear"></i> Settings</button>
        </div>
        <div id="admin-staff-wrap">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
            <h2 class="pg-title" style="margin:0;font-size:1.1rem">Staff Management</h2>
            <button type="button" class="btn btn-sm" id="add-staff-btn"><i class="fas fa-user-plus"></i> Add Staff</button>
          </div>
          <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap" id="staff-table"></div></div>
        </div>
        <div id="admin-settings-wrap" style="display:none">
          <h2 class="pg-title" style="margin:0 0 8px 0;font-size:1.1rem">Settings</h2>
          <p class="pg-sub" style="margin-bottom:16px">Parameters and options used across the app. Changes auto-save.</p>
          <div id="settings-lists"></div>
          <div class="settings-actions" style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn btn-outline btn-sm" id="export-config"><i class="fas fa-download"></i> Export</button>
            <button type="button" class="btn btn-outline btn-sm" id="import-config-btn"><i class="fas fa-upload"></i> Import</button>
            <button type="button" class="btn btn-outline btn-sm btn-danger" id="reset-config"><i class="fas fa-rotate-left"></i> Reset</button>
            <input type="file" id="cfg-file" accept=".json" style="display:none">
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Modal overlay -->
<div class="modal-overlay" id="modal-overlay"><div id="modal-container"></div></div>

<!-- Toast -->
<div id="toast" data-show="false"></div>

<!-- PWA Install banner -->
<div id="pwa-install-banner" class="pwa-install-banner" hidden>
  <div class="pwa-install-inner">
    <div class="pwa-install-icon"><i class="fas fa-brain"></i></div>
    <div class="pwa-install-text">
      <strong>Install CareTrack</strong>
      <span>Add to home screen for quick access</span>
    </div>
    <div class="pwa-install-actions">
      <button type="button" class="btn btn-ghost btn-sm" id="pwa-install-dismiss">Not now</button>
      <button type="button" class="btn btn-sm" id="pwa-install-btn"><i class="fas fa-download"></i> Install</button>
    </div>
    <button type="button" class="pwa-install-close" id="pwa-install-close" aria-label="Close"><i class="fas fa-times"></i></button>
  </div>
</div>

<!-- Firebase SDKs (compat for no-bundler setup) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- App scripts (order matters) -->
<script src="js/firebase-config.js"></script>
<script src="js/db.js"></script>
<script src="js/rtdb.js"></script>
<script src="js/components/modal.js"></script>
<script src="js/components/notifications.js"></script>
<script src="js/pages/dashboard.js"></script>
<script src="js/pages/patients.js"></script>
<script src="js/pages/patient-detail.js"></script>
<script src="js/pages/team.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
<script src="js/pages/family-report.js"></script>
<script src="js/pages/admin.js"></script>
<script src="js/pages/settings.js"></script>
<script src="js/app.js"></script>

</body>
</html>
